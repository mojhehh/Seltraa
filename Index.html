<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bookmarklets — Home & Admin (Firebase live)</title>

  <link rel="icon" type="image/png" href="/favicon.png">


  <!-- Tailwind for styling (optional) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + ReactDOM (UMD builds) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel (in-browser JSX compiler) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase compat SDKs (Realtime DB + Auth) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <meta name="viewport" content="width=device-width,initial-scale=1" />
</head>
<body class="bg-orange-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    /*******************************
     *  CONFIG — Replace this!
     *******************************/
const firebaseConfig = {
  apiKey: "AIzaSyD-7dcoBdsHa_sD8gRmvrifyLGP3HKKfI4",
  authDomain: "seltra.firebaseapp.com",
  databaseURL: "https://seltra-default-rtdb.firebaseio.com",
  projectId: "seltra",
  storageBucket: "seltra.firebasestorage.app",
  messagingSenderId: "1066404835444",
  appId: "1:1066404835444:web:25fda863eeace41594e121",
  measurementId: "G-TL3TJW23D2"
};

    /*******************************
     *  Initialize Firebase
     *******************************/
    if (!window.firebase.apps?.length) {
      try {
        firebase.initializeApp(firebaseConfig);
      } catch (e) {
        console.warn("Firebase init error (maybe config missing):", e.message);
      }
    }

    /*******************************
     *  firebaseDB wrapper (Realtime DB)
     *******************************/
    const firebaseDB = {
      get: async (path) => {
        if (!firebase.database) return null;
        const ref = firebase.database().ref(path);
        const snap = await ref.once('value');
        return snap.val();
      },
      push: async (path, data) => {
        const ref = firebase.database().ref(path).push();
        await ref.set(data);
        return ref.key;
      },
      delete: async (path) => {
        await firebase.database().ref(path).remove();
      },
      listen: (path, cb) => {
        const ref = firebase.database().ref(path);
        const handler = (snap) => cb(snap.val());
        ref.on('value', handler);
        return () => ref.off('value', handler);
      }
    };

    /*******************************
     *  firebaseAuth wrapper
     *******************************/
    const firebaseAuth = {
      signIn: async (email, password) => {
        if (!firebase.auth) throw new Error("Firebase Auth not loaded or configured.");
        return firebase.auth().signInWithEmailAndPassword(email, password);
      },
      signOut: async () => {
        if (!firebase.auth) return;
        return firebase.auth().signOut();
      },
      getCurrentUser: () => {
        if (!firebase.auth) return null;
        return firebase.auth().currentUser;
      },
      isAdmin: async () => {
        // returns true if /admins/{uid} is truthy
        const user = firebase.auth && firebase.auth().currentUser;
        if (!user) return false;
        const admins = await firebaseDB.get('admins/' + user.uid);
        return !!admins;
      },
      onAuthStateChanged: (cb) => {
        if (!firebase.auth) return () => {};
        return firebase.auth().onAuthStateChanged(cb);
      }
    };

    // helper
    function createPageUrl(name) {
      if (name.toLowerCase() === 'home') return '#/';
      if (name.toLowerCase() === 'admin') return '#/admin';
      return '#/';
    }

    /*******************************
     * Minimal UI components
     *******************************/
  function Logo({ size = "default" }) {
  const sizes = {
    small: "h-8",
    default: "h-12",
    large: "h-16"
  };

  return (
    <div className={`flex items-center gap-3 ${sizes[size]}`}>
      <svg 
        viewBox="0 0 48 48" 
        className={sizes[size]}
        fill="none" 
        xmlns="http://www.w3.org/2000/svg"
      >
        <defs>
          <linearGradient id="orangeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor="#FF8C42" />
            <stop offset="100%" stopColor="#FF6B35" />
          </linearGradient>
        </defs>
        <rect x="8" y="12" width="32" height="6" rx="3" fill="url(#orangeGradient)" />
        <rect x="8" y="21" width="24" height="6" rx="3" fill="url(#orangeGradient)" opacity="0.7" />
        <rect x="8" y="30" width="28" height="6" rx="3" fill="url(#orangeGradient)" opacity="0.5" />
        <circle cx="38" cy="24" r="6" fill="url(#orangeGradient)" />
      </svg>
      <span className="font-bold text-3xl tracking-tight bg-gradient-to-r from-orange-500 to-orange-600 bg-clip-text text-transparent">
        seltra
      </span>
    </div>
  );
}


    function Button({ children, className = '', onClick, type = 'button', disabled }) {
      return <button type={type} onClick={onClick} disabled={disabled} className={`px-3 py-2 rounded ${disabled ? 'opacity-60 cursor-not-allowed' : ''} ${className}`}>{children}</button>;
    }

    function Input(props) {
      return <input {...props} className={`border rounded px-3 py-2 w-full ${props.className || ''}`} />;
    }

    function Textarea(props) {
      return <textarea {...props} className={`border rounded px-3 py-2 w-full ${props.className || ''}`} />;
    }

    function Label({ children }) {
      return <label className="block text-sm font-medium text-gray-700 mb-1">{children}</label>;
    }

    function Card({ children, className = '' }) {
      return <div className={`bg-white rounded shadow-sm p-4 ${className}`}>{children}</div>;
    }

    function CardHeader({ children }) { return <div className="mb-2">{children}</div>; }
    function CardTitle({ children }) { return <h3 className="text-lg font-semibold">{children}</h3>; }
    function CardContent({ children }) { return <div>{children}</div>; }

    function Link({ to, children, className = '' }) {
      return <a href={to} className={className} onClick={(e)=>{ /* default anchor works */ }}>{children}</a>;
    }

    /*******************************
     * BookmarkletCard and Modal
     *******************************/
function BookmarkletCard({ bookmarklet }) {
  const copy = async () => {
    try {
      await navigator.clipboard.writeText(bookmarklet.code || '');
      alert('Bookmarklet copied to clipboard!');
    } catch {
      alert('Copy failed — select the code and copy manually.');
    }
  };

  return (
    <div className="border p-4 rounded bg-white">
      <h4 className="font-semibold text-gray-900">{bookmarklet.title || bookmarklet.name || 'Untitled'}</h4>
      {bookmarklet.description && <p className="text-sm text-gray-600">{bookmarklet.description}</p>}
      <div className="mt-2 flex gap-2">
        <Button className="bg-orange-500 text-white" onClick={copy}>Copy</Button>
      </div>
    </div>
  );
}



    function InstructionsModal({ open, onClose }) {
      if (!open) return null;
      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white p-6 rounded max-w-lg w-full">
            <h2 className="text-xl font-bold mb-4">How to use</h2>
            <p className="mb-4">Copy a bookmarklet and add it to your browser bookmarks. To run it, open the page you want and click the bookmark.</p>
            <div className="text-right">
              <Button className="bg-orange-500 text-white" onClick={onClose}>Close</Button>
            </div>
          </div>
        </div>
      );
    }

    /*******************************
     * Home Page
     *******************************/
    function Home() {
      const [showInstructions, setShowInstructions] = useState(false);
      const [isAdminFlag, setIsAdminFlag] = useState(false);
      const [categories, setCategories] = useState([]);
      const [bookmarklets, setBookmarklets] = useState([]);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        // listen to auth changes so admin button state updates after login
        const unsub = firebaseAuth.onAuthStateChanged(async (user) => {
          if (user) {
            try {
              const admin = await firebaseAuth.isAdmin();
              setIsAdminFlag(admin);
            } catch {
              setIsAdminFlag(false);
            }
          } else {
            setIsAdminFlag(false);
          }
        });

        // load data and realtime listeners
        loadData();
        const offCats = firebaseDB.listen('categories', (data) => {
          if (!data) { setCategories([]); return; }
          const arr = Object.keys(data).map(k => ({ id: k, ...data[k] }));
          arr.sort((a,b) => (a.order||0)-(b.order||0));
          setCategories(arr);
        });
        const offMarks = firebaseDB.listen('bookmarklets', (data) => {
          if (!data) { setBookmarklets([]); return; }
          const arr = Object.keys(data).map(k => ({ id: k, ...data[k] }));
          arr.sort((a,b) => (a.order||0)-(b.order||0));
          setBookmarklets(arr);
        });

        return () => {
          offCats();
          offMarks();
          if (unsub) unsub();
        };
      }, []);

      async function loadData() {
        setLoading(true);
        try {
          const [cats, marks] = await Promise.all([firebaseDB.get('categories'), firebaseDB.get('bookmarklets')]);
          if (cats) {
            const arr = Object.keys(cats).map(k => ({ id:k, ...cats[k] }));
            arr.sort((a,b)=>(a.order||0)-(b.order||0));
            setCategories(arr);
          } else setCategories([]);
          if (marks) {
            const arr = Object.keys(marks).map(k => ({ id:k, ...marks[k] }));
            arr.sort((a,b)=>(a.order||0)-(b.order||0));
            setBookmarklets(arr);
          } else setBookmarklets([]);
        } catch (e) {
          console.error(e);
        }
        setLoading(false);
      }

      const grouped = categories.map(cat => ({ ...cat, bookmarklets: bookmarklets.filter(b => b.categoryId === cat.id) })).filter(c=>c.bookmarklets.length>0);

      return (
        <div className="min-h-screen">
          <header className="border-b bg-white p-4 sticky top-0 z-20">
            <div className="container mx-auto flex justify-between items-center">
              <Logo />
              <div className="flex gap-3">
                <Button className="border" onClick={()=>setShowInstructions(true)}>How to Use</Button>
                {/* Admin always visible; AdminPage will require login */}
                <Link to={createPageUrl('Admin')} className="px-3 py-2 rounded bg-orange-500 text-white">Admin</Link>
              </div>
            </div>
          </header>

          <main className="container mx-auto px-4 py-12">
            <section className="text-center mb-12">
              <h1 className="text-4xl font-bold">Powerful Bookmarklets <span className="block text-orange-600">At Your Fingertips</span></h1>
              <p className="mt-4 text-gray-600">Copy, save, and use these handy bookmarklets.</p>
            </section>

            {loading ? (
              <div className="flex justify-center py-20"><div className="animate-spin h-10 w-10 border-b-2 rounded-full border-orange-600"></div></div>
            ) : grouped.length === 0 ? (
              <div className="text-center py-20 text-gray-500">No bookmarklets available yet.</div>
            ) : (
              grouped.map(cat => (
                <section key={cat.id} className="mb-10">
                  <div className="border-l-4 border-orange-500 pl-4 mb-4">
                    <h2 className="text-2xl font-bold">{cat.name}</h2>
                    {cat.description && <p className="text-sm text-gray-600">{cat.description}</p>}
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {cat.bookmarklets.map(b => <BookmarkletCard key={b.id} bookmarklet={b} />)}
                  </div>
                </section>
              ))
            )}
          </main>

          <InstructionsModal open={showInstructions} onClose={() => setShowInstructions(false)} />
        </div>
      );
    }

    /*******************************
     * Admin Page
     *******************************/
    function AdminPage() {
      const [isAdmin, setIsAdmin] = useState(false);
      const [categories, setCategories] = useState([]);
      const [bookmarklets, setBookmarklets] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showLogin, setShowLogin] = useState(false);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [loginError, setLoginError] = useState('');

      // Category form
      const [categoryForm, setCategoryForm] = useState({ name: '', description: '', order: 0 });

      // Bookmarklet form
      const [bookmarkletForm, setBookmarkletForm] = useState({
        title: '',
        description: '',
        code: '',
        categoryId: '',
        order: 0
      });

      useEffect(() => {
        // listen to auth state so admin UI updates immediately after login
        const unsub = firebaseAuth.onAuthStateChanged(async (user) => {
          if (!user) {
            setShowLogin(true);
            setIsAdmin(false);
            setLoading(false);
            return;
          }
          try {
            const adminStatus = await firebaseAuth.isAdmin();
            if (!adminStatus) {
              setShowLogin(true);
              setIsAdmin(false);
              setLoading(false);
              return;
            }
            setIsAdmin(true);
            setShowLogin(false);
            await loadData();
          } catch (e) {
            console.error(e);
            setShowLogin(true);
            setIsAdmin(false);
            setLoading(false);
          }
        });

        // initial check (in case user already signed in)
        (async () => {
          setLoading(true);
          const user = firebaseAuth.getCurrentUser();
          if (!user) {
            setShowLogin(true);
            setLoading(false);
          } else {
            try {
              const adminStatus = await firebaseAuth.isAdmin();
              if (!adminStatus) {
                setShowLogin(true);
                setLoading(false);
              } else {
                setIsAdmin(true);
                setShowLogin(false);
                await loadData();
              }
            } catch (e) {
              console.error(e);
              setShowLogin(true);
              setLoading(false);
            }
          }
        })();

        return () => { if (unsub) unsub(); };
      }, []);

      async function handleLogin(e) {
        e.preventDefault();
        setLoginError('');
        try {
          await firebaseAuth.signIn(email, password);
          // onAuthStateChanged listener will handle admin check and load data
        } catch (err) {
          setLoginError(err.message || 'Login failed');
        }
      }

      async function loadData() {
        setLoading(true);
        try {
          const [cats, marks] = await Promise.all([firebaseDB.get('categories'), firebaseDB.get('bookmarklets')]);
          if (cats) {
            const arr = Object.keys(cats).map(k => ({ id:k, ...cats[k] }));
            arr.sort((a,b)=>(a.order||0)-(b.order||0));
            setCategories(arr);
          } else setCategories([]);
          if (marks) {
           const arr = Object.keys(marks).map(k => ({ id:k, ...marks[k] }));
            arr.sort((a,b)=>(a.order||0)-(b.order||0));
            setBookmarklets(arr);
          } else setBookmarklets([]);
        } catch (e) {
          console.error(e);
          alert('Failed to load admin data: ' + (e.message || e));
        }
        setLoading(false);
      }

      async function handleAddCategory(e) {
        e.preventDefault();
        try {
          if (!categoryForm.name) { alert('Category name required'); return; }
          await firebaseDB.push('categories', categoryForm);
          setCategoryForm({ name: '', description: '', order: 0 });
          await loadData();
          alert('Category added');
        } catch (err) {
          console.error(err);
          alert('Failed to add category: ' + (err.message || err));
        }
      }

      async function handleDeleteCategory(id) {
        if (!confirm('Delete this category?')) return;
        try {
          await firebaseDB.delete(`categories/${id}`);
          await loadData();
          alert('Category deleted');
        } catch (err) {
          console.error(err);
          alert('Failed to delete category: ' + (err.message || err));
        }
      }

      async function handleAddBookmarklet(e) {
        e.preventDefault();
        try {
          // validate
          if (!bookmarkletForm.title || !bookmarkletForm.code || !bookmarkletForm.categoryId) {
            alert('Please fill Title, Code, and select a Category.');
            return;
          }
          // single-line minify
          const minifiedCode = (bookmarkletForm.code || '').replace(/\s+/g, ' ').trim();
          const pushKey = await firebaseDB.push('bookmarklets', { ...bookmarkletForm, code: minifiedCode });
          setBookmarkletForm({ title: '', description: '', code: '', categoryId: '', order: 0 });
          await loadData();
          alert('Bookmarklet added (id: ' + pushKey + ')');
        } catch (err) {
          console.error(err);
          alert('Failed to add bookmarklet: ' + (err.message || err));
        }
      }

      async function handleDeleteBookmarklet(id) {
        if (!confirm('Delete this bookmarklet?')) return;
        try {
          await firebaseDB.delete(`bookmarklets/${id}`);
          await loadData();
          alert('Bookmarklet deleted');
        } catch (err) {
          console.error(err);
          alert('Failed to delete bookmarklet: ' + (err.message || err));
        }
      }

      if (showLogin) {
        return (
          <div className="min-h-screen flex items-center justify-center p-4">
            <Card className="w-full max-w-md">
              <CardHeader className="text-center">
                <Logo size="large" />
                <CardTitle className="text-2xl mt-4">Admin Login</CardTitle>
              </CardHeader>
              <CardContent>
                <form onSubmit={handleLogin} className="space-y-4">
                  <div>
                    <Label>Email</Label>
                    <Input type="email" value={email} onChange={(e)=>setEmail(e.target.value)} placeholder="admin@example.com" required autoComplete="email" />
                  </div>
                  <div>
                    <Label>Password</Label>
                    <Input type="password" value={password} onChange={(e)=>setPassword(e.target.value)} placeholder="••••••" required autoComplete="current-password" />
                  </div>
                  {loginError && <div className="bg-red-50 border border-red-200 text-red-700 p-3 rounded">{loginError}</div>}
                  <Button type="submit" className="w-full bg-orange-500 text-white">Sign In</Button>
                  <div className="mt-2 text-center">
                    <Link to={createPageUrl('Home')}><Button className="border">Back to Home</Button></Link>
                  </div>
                </form>
              </CardContent>
            </Card>
          </div>
        );
      }

      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="animate-spin h-10 w-10 border-b-2 rounded-full border-orange-600"></div>
          </div>
        );
      }

      return (
        <div className="min-h-screen">
          <header className="border-b bg-white p-4 sticky top-0">
            <div className="container mx-auto flex justify-between items-center">
              <Logo />
              <div>
                <Link to={createPageUrl('Home')}><Button className="border">Back to Home</Button></Link>
              </div>
            </div>
          </header>

          <main className="container mx-auto px-4 py-8">
            <h1 className="text-3xl font-bold mb-6">Admin Panel</h1>

            {/* Categories */}
            <section className="mb-8">
              <Card className="mb-4">
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">Add New Category</CardTitle>
                </CardHeader>
                <CardContent>
                  <form onSubmit={handleAddCategory} className="space-y-3">
                    <div>
                      <Label>Category Name</Label>
                      <Input value={categoryForm.name} onChange={(e)=>setCategoryForm({...categoryForm, name: e.target.value})} required />
                    </div>
                    <div>
                      <Label>Description</Label>
                      <Textarea value={categoryForm.description} onChange={(e)=>setCategoryForm({...categoryForm, description: e.target.value})} rows={3} />
                    </div>
                    <div>
                      <Label>Order</Label>
                      <Input type="number" value={categoryForm.order} onChange={(e)=>setCategoryForm({...categoryForm, order: parseInt(e.target.value || '0')})} min="0" />
                    </div>
                   <Button type="submit" className="bg-orange-500 text-white">Add Category</Button>
                  </form>
                </CardContent>
              </Card>

              <Card>
                <CardHeader><CardTitle>Existing Categories ({categories.length})</CardTitle></CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    {categories.length === 0 && <p className="text-gray-500 text-center py-4">No categories yet.</p>}
                    {categories.map(c => (
                      <div key={c.id} className="flex items-center justify-between p-3 bg-orange-50 rounded border">
                        <div>
                          <div className="font-semibold">{c.name}</div>
                          {c.description && <div className="text-sm text-gray-600">{c.description}</div>}
                          <div className="text-xs text-gray-500">Order: {c.order || 0}</div>
                        </div>
                        <div>
                          <Button className="border" onClick={()=>handleDeleteCategory(c.id)}>Delete</Button>
                        </div>
                      </div>
                    ))}
                  </div>
                </CardContent>
              </Card>
            </section>

            {/* Bookmarklets */}
            <section>
              <Card className="mb-4">
                <CardHeader><CardTitle>Add New Bookmarklet</CardTitle></CardHeader>
                <CardContent>
                  <form onSubmit={handleAddBookmarklet} className="space-y-3">
                    <div>
                      <Label>Title</Label>
                      <Input value={bookmarkletForm.title} onChange={(e)=>setBookmarkletForm({...bookmarkletForm, title: e.target.value})} required />
                    </div>
                    <div>
                      <Label>Description</Label>
                      <Textarea value={bookmarkletForm.description} onChange={(e)=>setBookmarkletForm({...bookmarkletForm, description: e.target.value})} rows={2} />
                    </div>
                    <div>
                      <Label>Code (javascript:...)</Label>
                      <Textarea value={bookmarkletForm.code} onChange={(e)=>setBookmarkletForm({...bookmarkletForm, code: e.target.value})} rows={5} className="font-mono text-sm" required />
                    </div>
                    <div>
                      <Label>Category</Label>
                      <select value={bookmarkletForm.categoryId} onChange={(e)=>setBookmarkletForm({...bookmarkletForm, categoryId: e.target.value})} className="w-full border rounded px-3 py-2">
                        <option value="">Select a category</option>
                        {categories.map(cat => <option key={cat.id} value={cat.id}>{cat.name}</option>)}
                      </select>
                    </div>
                    <div>
                      <Label>Order</Label>
                      <Input type="number" value={bookmarkletForm.order} onChange={(e)=>setBookmarkletForm({...bookmarkletForm, order: parseInt(e.target.value || '0')})} min="0" />
                    </div>
                  <Button type="submit" className="bg-orange-500 text-white">Add Bookmarklet</Button>
                  </form>
                </CardContent>
              </Card>

              <Card>
                <CardHeader><CardTitle>Existing Bookmarklets ({bookmarklets.length})</CardTitle></CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    {bookmarklets.length === 0 && <p className="text-gray-500 text-center py-4">No bookmarklets yet.</p>}
                    {bookmarklets.map(b => (
                      <div key={b.id} className="flex items-start justify-between p-3 bg-orange-50 rounded border">
                        <div className="flex-1">
                          <div className="font-semibold">{b.title}</div>
                          {b.description && <div className="text-sm text-gray-600">{b.description}</div>}
                          <pre className="mt-2 p-2 bg-gray-100 rounded text-xs font-mono overflow-x-auto">{(b.code || '').substring(0, 200)}</pre>
                          <div className="text-xs text-gray-500 mt-1">Order: {b.order || 0} | Category: {categories.find(c=>c.id===b.categoryId)?.name || 'Unknown'}</div>
                        </div>
                        <div className="ml-4">
                          <Button className="border" onClick={()=>handleDeleteBookmarklet(b.id)}>Delete</Button>
                        </div>
                      </div>
                    ))}
                  </div>
                </CardContent>
              </Card>
            </section>

          </main>
        </div>
      );
    }

    /*******************************
     *  Small router (hash-based)
     *******************************/
    function AppRouter() {
      const [route, setRoute] = useState(window.location.hash || '#/');

      useEffect(() => {
        const onHash = () => setRoute(window.location.hash || '#/');
        window.addEventListener('hashchange', onHash);
        return () => window.removeEventListener('hashchange', onHash);
      }, []);

      if (route.startsWith('#/admin')) return <AdminPage />;
      return <Home />;
    }

    /*******************************
     *  Render
     *******************************/
    ReactDOM.createRoot(document.getElementById('root')).render(<AppRouter />);

  </script>
</body>
</html>
